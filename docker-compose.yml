services:
  # 1. Web Service (Producer)
  web:
    build: ./web
    container_name: web
    ports:
      - "8080:8080"
    depends_on:
      - mongo
      - rabbitmq
    networks:
      - app-net
    env_file:
      - ./.env
    environment:
      MONGO_URI: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/"
      DB_NAME: "${DB_NAME}"
      RABBITMQ_HOST: "${RABBITMQ_HOST}" # (เพิ่มให้ web รู้จัก rabbitmq)
    restart: unless-stopped # (แนะนำให้เพิ่ม)

  # 2. Mongo Service (Database)
  mongo:
    image: mongo:6
    container_name: mongo
    ports:
      - "27017:27017"
    networks:
      - app-net
    env_file:
      - ./.env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped # (แนะนำให้เพิ่ม)

  # 3. RabbitMQ Service (Message Queue)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - app-net
    env_file:
      - ./.env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    restart: unless-stopped # (แนะนำให้เพิ่ม)

  # 4. Scheduler Service (Producer)
  scheduler:
    build: ./scheduler
    container_name: scheduler
    depends_on:
      - mongo
      - rabbitmq
    networks:
      - app-net
    env_file:
      - ./.env
    environment:
      MONGO_URI: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/"
      DB_NAME: "${DB_NAME}"
      RABBITMQ_HOST: "${RABBITMQ_HOST}"
    restart: unless-stopped # (แนะนำให้เพิ่ม)

  # 5. Worker Service (Consumer) --- (นี่คือส่วนที่เพิ่มเข้ามา) ---
  worker:
    build: ./worker            # 1. Build จากโฟลเดอร์ ./worker
    container_name: worker
    depends_on:                # 2. ต้องรันหลังจาก mongo และ rabbitmq พร้อม
      - mongo
      - rabbitmq
    networks:                  # 3. เชื่อม Network เดียวกัน
      - app-net
    env_file:                  # 4. ใช้ .env ไฟล์เดียวกัน
      - ./.env
    environment:               # 5. ส่งค่า Environment ให้อ่าน (เหมือนกับตัวอื่น)
      MONGO_URI: "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/"
      DB_NAME: "${DB_NAME}"
      RABBITMQ_HOST: "${RABBITMQ_HOST}"
    restart: unless-stopped    # 6. (แนะนำ) ให้มันเริ่มใหม่เองถ้าล้มเหลว

networks:
  app-net:
    driver: bridge

volumes:
  mongo-data:
